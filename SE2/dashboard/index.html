<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incident Summary Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app">
    <header class="header">
      <h1>Incident Summary</h1>
      <p class="subtitle">Uncertainty-aware • Evidence only • No asserted facts <a href="analytics.html" class="link-analytics">Snowflake Analytics →</a></p>
      <div class="api-status" id="api-status">Checking API…</div>
    </header>

    <main class="main">
      <section class="panel voice-panel">
        <h2>Live voice transcription</h2>
        <p class="panel-hint">Start recording to add transcripts via speech. Every ~3 sentences are sent to the semantic engine and incidents update in real time. Each session (Start→Stop) = one caller.</p>
        <div class="voice-controls">
          <button type="button" id="voice-start" class="primary">Start recording</button>
          <button type="button" id="voice-stop" class="secondary" disabled>Stop</button>
          <span id="voice-status" class="voice-status">Idle</span>
          <span id="voice-caller" class="voice-caller hidden"></span>
        </div>
        <div id="voice-live" class="voice-live" aria-live="polite"></div>
        <div id="voice-transcript" class="voice-transcript"></div>
      </section>

      <section class="panel ingest-panel">
        <h2>Ingest transcript chunk</h2>
        <p class="panel-hint" style="margin-bottom:0.5rem">Or <strong>Simulate incidents</strong> to seed demo data (fire, medical, assault, gas leak) with locations for the map and Snowflake analytics.</p>
        <button type="button" id="simulate-incidents" class="secondary" style="margin-bottom:1rem">Simulate incidents</button>
        <form id="chunk-form">
          <label class="checkbox-row">
            <input type="checkbox" id="auto-cluster" title="Assign to best-matching incident or create new (embedding + LLM + time)" checked>
            Auto-cluster reports (no incident ID needed)
          </label>
          <div id="incident-id-row" class="hidden">
            <label for="incident-id">Incident ID</label>
            <input type="text" id="incident-id" value="incident-001" placeholder="incident-001">
          </div>
          <label for="chunk-text">Transcript text</label>
          <textarea id="chunk-text" rows="4" placeholder="e.g. there is a fire on the third floor"></textarea>
          <div class="device-location-row">
            <button type="button" id="use-my-location" class="secondary">Use my location</button>
            <span id="device-location-status" class="device-status"></span>
          </div>
          <button type="submit" id="submit-chunk">Process chunk</button>
        </form>
        <div id="chunk-result" class="result-box"></div>
      </section>

      <section class="panel incidents-list-panel">
        <div class="panel-head-row">
          <h2>All incidents</h2>
          <button type="button" id="refresh-incidents" class="secondary">Refresh list</button>
        </div>
        <p class="panel-hint">Click a card to view details.</p>
        <div id="incidents-loading" class="loading">Loading…</div>
        <div id="incidents-cards" class="incidents-cards hidden"></div>
        <div id="incidents-empty" class="loading hidden">No incidents yet. Submit a transcript with auto-cluster on.</div>
      </section>

      <section class="panel summary-panel">
        <h2>Incident details</h2>
        <p class="panel-hint">Click an incident card above to see summary, transcripts, and timeline.</p>
        <div id="summary-loading" class="loading">Click an incident above or process a chunk.</div>
        <div id="summary-content" class="summary-content hidden">
          <div class="field">
            <span class="label">Incident ID</span>
            <span id="sum-incident-id"></span>
          </div>
          <div class="field">
            <span class="label">Last updated</span>
            <span id="sum-last-updated"></span>
          </div>
          <div class="field">
            <span class="label">Device location</span>
            <span id="sum-device-location" class="confidence-value"></span>
          </div>
          <div class="field">
            <span class="label">Locations (mentioned)</span>
            <div id="sum-locations" class="confidence-value locations-list"></div>
          </div>
          <div class="field">
            <span class="label">Incident type</span>
            <span id="sum-incident-type" class="confidence-value"></span>
          </div>
          <div class="field">
            <span class="label">People estimate</span>
            <span id="sum-people" class="confidence-value"></span>
          </div>
          <div class="field">
            <span class="label">Hazards</span>
            <div id="sum-hazards" class="confidence-value locations-list"></div>
          </div>
          <h3 class="details-subsection">Transcripts / Callers</h3>
          <div id="transcripts-section" class="transcripts-section hidden">
            <div id="transcripts-list" class="transcripts-list"></div>
          </div>
          <button type="button" id="refresh-summary" class="secondary">Refresh</button>
        </div>
      </section>

      <section class="panel map-panel">
        <h2>Map</h2>
        <p class="map-hint">Main marker shows incident type. Use &quot;Use my location&quot; then process a chunk, or &quot;Simulate locations&quot; for demo.</p>
        <button type="button" id="simulate-locations" class="secondary">Simulate locations</button>
        <div id="map" class="map-container"></div>
      </section>

      <section class="panel timeline-panel">
        <h2>Timeline (audit log)</h2>
        <div id="timeline-loading" class="loading">No timeline yet.</div>
        <div id="timeline-content" class="timeline-content hidden">
          <ul id="timeline-list"></ul>
        </div>
      </section>
    </main>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="app.js"></script>
</body>
</html>
